/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function e(e,t,n,o){var s,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var i=e.length-1;i>=0;i--)(s=e[i])&&(a=(r<3?s(a):r>3?s(t,n,a):s(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a}function t(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],o=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&o>=e.length&&(e=void 0),{value:e&&e[o++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function n(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,o=e[Symbol.asyncIterator];return o?o.call(e):(e=t(e),n={},s("next"),s("throw"),s("return"),n[Symbol.asyncIterator]=function(){return this},n);function s(t){n[t]=e[t]&&function(n){return new Promise((function(o,s){(function(e,t,n,o){Promise.resolve(o).then((function(t){e({value:t,done:n})}),t)})(o,s,(n=e[t](n)).done,n.value)}))}}}function o(e){return function(t,n){let o;Object.defineProperty(t,n,{get:function(){return o},set:function(t){const n=o;o=t,n!==t&&A.send({name:e,oldValue:n,newValue:t},{toGW:!1})}})}}const s=Object.keys({disconnected:0,connecting:1,connected:2,failed:3,reconnecting:4,closed:5});function r(){var e;return(null===(e=global.crypto)||void 0===e?void 0:e.randomUUID)?global.crypto.randomUUID():i(a(32),8)+"-"+i(a(16),4)+"-"+i(16384|a(12),4)+"-"+i(32768|a(14),4)+"-"+i(a(48),12)}function a(e){return e<0?NaN:e<=30?0|Math.random()*(1<<e):e<=53?(0|Math.random()*(1<<30))+(0|Math.random()*(1<<e-30))*(1<<30):NaN}function i(e,t){let n=e.toString(16),o=t-n.length,s="0";for(;o>0;o>>>=1,s+=s)1&o&&(n=s+n);return n}const c=-1,l=3001,d=((e,t="")=>(n,...o)=>{const s=e[n];return t+(s?((e,...t)=>e.replace(/{(\d+)}/g,(function(e,n){return void 0!==t[n-1]?t[n-1]:e})))(s,...o):n)})(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},{TEST_REPLACE:"This is a {1} {2} replace"}),{TRACE_CONN_ACK_RECEIVED:"ASK message: received ask {1}, local clock {2}, minimal stored clock {3}",TRACE_CONN_ACK_CLEARED:"ASK message: cleared {1} msg from the pool.",TRACE_CONN_RETRANSMIT:"LastRTX message: requested from {1} current {2} total requested {3} can be sent {4}"}),{INFO_CONN_START_CONNECTION:"Start connecting procedure",INFO_CONN_BALANCER:"Request balancer url {1}",INFO_CONN_TRANSPORT_CONNECTED:"WsTransport was connected uuid:{1}",INFO_CONN_TRANSPORT_CLOSED:"WsTransport was closed unexpectedly uuid:{1} reason:{2} code {3}",INFO_CONN_TRANSPORT_DESTROY:"WsTransport was successful closed uuid:{1}",INFO_CONN_CONNECTION_POOL:"Connecting to Voximplant gateways: {1}",INFO_CONN_CONNECT:"Trying to connect with {1}",INFO_CONN_CONNECT_SUCCESSFUL:"Connection with {1} was successful",INFO_CONN_RECONNECT_NEEDED:"Trying to restore connection",INFO_CONN_RECONNECT:"Attempt to reconnect #{1}",INFO_CONN_RECONNECT_ATTEMPT_FAILED:"Attempt failed. Timeout.",INFO_CONN_CLEAR:"Start disconnecting procedure.",INFO_CONN_MESSAGE:'New message from WsTransport uuid: {1}. "{2}"',INFO_CONN_CONNECTION_ID_SET:"Set new connection id: {1}",INFO_TRANSPORT_CLOSED:"WsTransport {1} was closed with code {2} reason: {3}"}),{WARN_CORE_WRONG_EVENT:"{1} internal event is unhandled. Looks like you forgot to connect some module. If you can't solve this yourself, please contact our technical support at support@voximplant.com.",WARN_CORE_UNMET_DEP:'Module "{1}" v{2}.{3}.{4} have unmet dependency "{5}" v{6}.{7}.${8}. Skipped...',WARN_CORE_CONFLICT_DEP:'Module "{1}" v{2}.{3}.{4} have conflict with the module "{5}" v{6}.{7}.${8}. Skipped...',WARN_CONN_WRONG_BALANCER_URL:'The Balancer URL must be secure. "{1}" not starts with "https://"',WARN_CONN_WRONG_STATE:"You try to {1} in the wrong state {2}({3})",WARN_CONN_WRONG_SEQ:"Received seq={1}, last seq={2}. WsTransport {3} will terminated.",WARN_TRANSPORT_NO_HANDLER:"WsTransport {1} has no message handler. Message was dropped.",WARN_TRANSPORT_NO_CLOSE_HANDLER:"WsTransport {1} has no close handler."}),{ERR_NOT_CONFIGURED:"Voximplant WebSDK not configured yet. Please use SDK.configure before using any Voximplant WsbSDK functions.",ERR_LOADING_MODULE:"Error loading module: ",ERR_MODULE_CONSTRUCTOR:"The modules field must be array",ERR_CORE_HANDLER_THROW:'Some module throw error while handle the "{1}" event. Error message is "{2}"',ERR_CORE_PRE_HANDLER_THROW:'Some module throw error while pre handle the "{1}" event. Error message is "{2}"',ERR_CORE_POST_HANDLER_THROW:'Some module throw error while post handle the "{1}" event. Error message is "{2}"',ERR_STATE_IS_READONLY:"SDK.state is read only.",ERR_CONFIG_IS_READONLY:"SDK.config is read only.",ERR_AlREADY_CONNECTED:'SDK already connected. Please use "async SDK.disconnect()" at first place.',ERR_AlREADY_AUTHORIZED:'SDK already authorized in the Voximplant cloud. Please use "async SDK.disconnect()" at first place.',ERR_NOT_CONNECTED_YET:'SDK not connected yet. Please use "async SDK.connect()" at first place.',ERR_CONN_WRONG_BALANCER_RESPONSE:'Wrong balancer response. "{1}" from "{2}"',ERR_CONN_FAILED:"Connection failed. Reason: {1}",ERR_CONN_CLOUD_IS_UNREACHABLE:"Voximplant cloud is unreachable. List of servers {1}",ERR_CONN_MESSAGE_PARSING_ERR:"Error while parsing message from WsTransport",ERR_CONN_MESSAGE_FORMAT_TYPE:'Error in message from WsTransport: "{1}" field not set.',ERR_CONN_CONNECTION_ID_ALREADY_SET:"Connection id already set and can't be updated."}),{THROW_WRONG_ENVIRONMENT:"Wrong environment",THROW_WRONG_MODULES_CONSTRUCTOR:"Modules config must be an array or a function that returns array"}));class u{constructor(){this.state=0,this.uuid=r()}send(e){this.ws.send(e)}destroy(e,t){e!==c?this.ws.close(e,t):this.state=4}async connect(e){return new Promise((t=>{this.state=1,this.ws=new WebSocket(e);const n=e=>{this.state=0,t(!1)};this.ws.addEventListener("open",(()=>{this.state=2,this.ws.removeEventListener("error",n),this.ws.addEventListener("message",(e=>{this.messageHandler?this.messageHandler(e.data,this):fe.log(d("WARN_TRANSPORT_NO_HANDLER",this.uuid),{logLevel:"warning"})})),this.ws.addEventListener("close",(({reason:e,code:t,wasClean:n})=>{4!==this.state&&(this.state=4,fe.log(d("INFO_TRANSPORT_CLOSED",this.uuid,t.toString(),e),{logLevel:"info"}),this.onClose?this.onClose(this,{reason:e,code:t,wasClean:n}):fe.log(d("WARN_TRANSPORT_NO_CLOSE_HANDLER",this.uuid),{logLevel:"warning"}),this.ws.close())})),t(!0)})),this.ws.addEventListener("error",n)}))}}function h(e,t){return function(...n){return new Promise((o=>{setTimeout((async function(){const t=await e.apply(n);o(t)}),t)}))}}const g={loginFailed:["code","extra"],loginSuccessful:["displayName","params"],__onPCStats:["stats"],handleIncomingConnection:["id","headers","sdp","extra"],handleConnectionConnected:["id","headers","sdp","endpointData","scheme"],handleConnectionDisconnected:["id","headers","params"],handleRingOut:["id"],startEarlyMedia:["id","headers","sdp","scheme"],stopRinging:["id"],handleConnectionFailed:["id","code","reason","headers"],handleSIPInfo:["id","type","subType","body","headers"],handleSipEvent:["id","index","payload"],handleTransferStarted:["id"],handleTransferComplete:["id"],handleTransferFailed:["id"],handleReInvite:["id","headers","sdp","scheme"],handleAcceptReinvite:["id","headers","sdp"],handleRejectReinvite:["id","headers","sdp"],__createPC:["id","sdp"],__destroyPC:["id"],__connectionSuccessful:["token"],__connectionFailed:[],__createConnection:["token"],__pong:[],increaseGain:[],handlePreFlightCheckResult:["a","b","c"],handleVoicemail:["event"],refreshOauthTokenFailed:["code"],refreshOauthTokenSuccessful:["oauth"],registerPushTokenResult:["result"],unregisterPushTokenResult:["result"],sipRegisterSuccessful:["id","sipUri"],sipRegisterFailed:["id","sipUri","status","reason"],onACDStatus:["id","status","uuid"],onMessagingStatus:["id","status","uuid"],onSQStatusError:["id","uuid","code","description"],onICEConfig:["id","config"],onICEConfigFailed:["id"]},N={__ping:[],login:["username","password","options"],loginGenerateOneTimeKey:["username"],loginUsingOneTimeKey:["username","hash","options"],setOperatorACDStatus:[],getOperatorACDStatus:[],setOperatorMessagingStatus:[],getOperatorMessagingStatus:[],setDesiredVideoBandwidth:[],rejectCall:[],disconnectCall:["id","headers"],sendDTMF:[],sendSIPInfo:["id","type","subType","message","headers"],hold:[],unhold:[],acceptCall:[],createCall:[],callConference:["reserved_1","number","isVideo","id","reserved_2","reserved_3","headers","reserved_4","sdp","midData"],transferCall:[],__muteLocal:[],ReInvite:["id","headers","sdp","extra"],AcceptReInvite:["id","headers","sdp","extra"],RejectReInvite:["id","headers"],__confirmPC:[],__addCandidate:[],refreshOauthToken:[],promptFinished:[],registerPushToken:[],unregisterPushToken:[],pushFeedback:[]};function O(e,t){const n=N[e];if(!n)throw new Error(`Rule unknown for ${e}`);return n.reduce(((e,n)=>{const o=t[n]||null;return e.push(o),e}),[])}var _;!function(e){e[e.INTERNAL_ERROR=1]="INTERNAL_ERROR",e[e.INVALID_CONNECTION_ID=2]="INVALID_CONNECTION_ID",e[e.TOO_LATE=3]="TOO_LATE",e[e.WRONG_TRANSPORT_FORMAT=4]="WRONG_TRANSPORT_FORMAT",e[e.TRANSPORT_ERROR=5]="TRANSPORT_ERROR"}(_||(_={}));class m{constructor(e,t,n){this.sdkInstance=e,this.config=t,this.connectionConstructor=n,this.state=0,this.awaitingTransportHandler=null,this.messageHandler=async(e,t)=>{this.sdkInstance.log(d("INFO_CONN_MESSAGE",t.uuid,e),{logLevel:"info"});try{const n=JSON.parse(e);if(!n.type)return void this.sdkInstance.log(d("ERR_CONN_MESSAGE_FORMAT_TYPE","type"),{logLevel:"error"});switch(n.type){case"close":this.validateSeq(n.seq,t)&&await this.processClose(n);break;case"ack":this.checkConnectionId(t)&&await this.processAck(n);break;case"error":await this.processError(n);break;case"id":this.validateConnectionId(n,t)&&(await this.setConnectionId(n),await this.sendData({type:"lastrx",seq:this.remoteClock}));break;case"lastrx":this.checkConnectionId(t)&&await this.processLastRtx(n);break;case"msg":this.checkConnectionId(t)&&this.validateSeq(n.seq,t)&&await this.processMsg(n);break;default:this.sdkInstance.log(d("ERR_CONN_MESSAGE_FORMAT_TYPE","type"),{logLevel:"error"})}}catch(e){this.sdkInstance.log(d("ERR_CONN_MESSAGE_PARSING_ERR"),{logLevel:"error"})}},this.onTransportClose=async(e,t)=>{if(this.sdkInstance.log(d("INFO_CONN_TRANSPORT_CLOSED",e.uuid,t.reason,t.code.toString()),{logLevel:"info"}),e.onClose=null,e.messageHandler=null,!this.transportList.has(e))return;const n=Array.from(this.transportList).some((e=>1===e.state||0===e.state));this.transportList.delete(e),n?console.log("has alive tr"):this.connectionId?(this.sdkInstance.log(d("INFO_CONN_RECONNECT_NEEDED"),{logLevel:"info"}),2===this.state&&(this.state=4,console.log("go to reconnect"),await this.reconnect()?this.state=2:this.state=3)):this.state=3}}async send(e){const t=++this.localClock,n={type:"msg",seq:t,payload:e};this.messagePool.set(t,n),1===this.state||2===this.state||4===this.state?await this.sendData(n):this.sdkInstance.log(d("WARN_CONN_WRONG_STATE","send message",this.sdkInstance.state,""+this.state),{logLevel:"warning"})}async requestBalancer(){var e,t,n,o;let s="https://balancer.voximplant.com/getNearestHost";(null===(e=this.config)||void 0===e?void 0:e.balancerUrl)&&(0===(null===(t=this.config)||void 0===t?void 0:t.balancerUrl.indexOf("https://"))?s=null===(n=this.config)||void 0===n?void 0:n.balancerUrl:this.sdkInstance.log(d("WARN_CONN_WRONG_BALANCER_URL",null===(o=this.config)||void 0===o?void 0:o.balancerUrl),{logLevel:"warning"})),this.sdkInstance.log(d("INFO_CONN_BALANCER",s),{logLevel:"info"});try{const e=await global.fetch(s),t=await e.text();if(200!==e.status)throw new Error(`Response code: ${e.status}`);if(0===t.length)throw new Error("Response body is empty");return t.split(";")}catch(e){console.error(e),this.sdkInstance.log(d("ERR_CONN_WRONG_BALANCER_RESPONSE",e.message,s),{logLevel:"error"})}return[]}makeConnectionURL(e){var t,n;let o="nodejs";const s=global.navigator;return(null==s?void 0:s.mozGetUserMedia)?o="firefox":(null==s?void 0:s.webkitGetUserMedia)?o="chrome":s&&(o="safari"),`wss://${e}/platform?version=5&client_version=${this.sdkInstance.version}&video=true&ccheck=false&client_platform=${o}&im_version=${(null===(t=this.config)||void 0===t?void 0:t.imVersion)||2}&acd_version=${(null===(n=this.config)||void 0===n?void 0:n.acdVersion)||1}${this.connectionId?"&id="+this.connectionId:""}`}async connect(){var e;if(this.sdkInstance.log(d("INFO_CONN_START_CONNECTION"),{logLevel:"info"}),this.state>0)return void this.sdkInstance.log(d("WARN_CONN_WRONG_STATE","connect",s[this.state],""+this.state),{logLevel:"warning"});this.state=1,this.localClock=0,this.remoteClock=0,this.messagePool=new Map,this.transportList=new Set;const t=(null===(e=this.config)||void 0===e?void 0:e.servers)||await this.requestBalancer();if(0===t.length){const e=d("ERR_CONN_FAILED","No gateways to connect");throw this.sdkInstance.log(e,{logLevel:"error"}),this.state=3,new Error(e)}return this.sdkInstance.log(d("INFO_CONN_CONNECTION_POOL",t.join(", ")),{logLevel:"info"}),new Promise(((e,n)=>{const o=setTimeout((()=>{this.state=3,e()}),5e3);this.firstConnection(t).then((s=>{if(clearTimeout(o),s)this.state=2,e();else{const e=d("ERR_CONN_FAILED",d("ERR_CONN_CLOUD_IS_UNREACHABLE",t.join(", ")));this.sdkInstance.log(e,{logLevel:"error"}),this.state=3,n()}}))}))}async clear(){await this.clearRoutine(!0)}validateSeq(e,t){return e===this.remoteClock+1||(1===this.state?(this.awaitingTransportHandler&&(this.awaitingTransportHandler.resolve(!1),this.destroyTransportSilent(this.awaitingTransportHandler.transport),this.awaitingTransportHandler=null),!1):(this.sdkInstance.log(d("INFO_CONN_BALANCER",e.toString(),this.remoteClock.toString(),t.uuid),{logLevel:"warning"}),t.destroy(l,"Wrong seq"),!1))}async processError(e){this.awaitingTransportHandler&&(this.awaitingTransportHandler.resolve(!1),this.destroyTransportSilent(this.awaitingTransportHandler.transport),this.awaitingTransportHandler=null),this.sdkInstance.log(e.msg,{logLevel:"error"})}async setConnectionId(e){this.sdkInstance.log(d("INFO_CONN_CONNECTION_ID_SET",e.id),{logLevel:"info"}),this.connectionId=e.id}checkConnectionId(e){return!!this.connectionId||(this.awaitingTransportHandler&&this.awaitingTransportHandler.transport===e&&(this.awaitingTransportHandler.resolve(!1),this.awaitingTransportHandler=null),this.destroyTransportSilent(e),!1)}validateConnectionId(e,t){return!this.connectionId||(this.connectionId===e.id||(this.awaitingTransportHandler&&this.awaitingTransportHandler.transport===t?(this.awaitingTransportHandler.resolve(!1),this.awaitingTransportHandler=null,this.destroyTransportSilent(t)):t.destroy(),!1))}async processAck(e){const t=Array.from(this.messagePool.keys()).sort()[0];this.sdkInstance.log(d("TRACE_CONN_ACK_RECEIVED",e.seq.toString(),this.localClock.toString(),t.toString()),{logLevel:"trace"});let n=0;for(let o=t;o<=e.seq;o++)this.messagePool.has(o)&&(this.messagePool.delete(o),n++);this.sdkInstance.log(d("TRACE_CONN_ACK_CLEARED",n.toString()),{logLevel:"trace"})}async processLastRtx(e){const t=this.localClock-e.seq;let n=0;for(let t=e.seq;t<=this.localClock;t++){const e=this.messagePool.get(t);e&&(await this.sendData(e),n++)}n<t&&await this.sendData({type:"error",msg:"Too late",code:_.TOO_LATE}),this.sdkInstance.log(d("TRACE_CONN_RETRANSMIT",e.seq.toString(),this.localClock.toString(),t.toString(),n.toString()),{logLevel:"trace"}),this.awaitingTransportHandler&&t>=0?(this.awaitingTransportHandler.resolve(!0),this.awaitingTransportHandler=null):this.awaitingTransportHandler&&(this.awaitingTransportHandler.resolve(!1),this.destroyTransportSilent(this.awaitingTransportHandler.transport))}async processClose(e){await this.clearRoutine(!1)}async processMsg(e){this.remoteClock=e.seq,this.sendACK(),await A.send(this.transformMsgPayload(e),{toGW:!1})}transformMsgPayload(e){if(e.payload.service){const t=e.payload;return Object.assign({name:`${t.service}.${t.event}`},e.payload)}if(e.payload.name){const t=e.payload;return Object.assign({name:`GW.${t.name}`},function(e,t){const n=g[e];if(!n)throw new Error(`Rule unknown for ${e}`);return t.reduce(((e,t,o)=>{let s=1;const r=n[o];return r?e[r]=t:(e[`unknownField${s.toString()}`]=t,s++),e}),{})}(t.name,t.params))}return{name:"UnknownGWMessage",payload:e.payload}}sendACK(){this.sendData({type:"ack",seq:this.remoteClock}).catch((e=>{}))}async sendData(e){var t,o;const s=this.transportList.values();try{for(var r,a=n(s);!(r=await a.next()).done;){const t=r.value;await t.send(JSON.stringify(e))}}catch(e){t={error:e}}finally{try{r&&!r.done&&(o=a.return)&&await o.call(a)}finally{if(t)throw t.error}}}async reconnect(){this.sdkInstance.log(d("INFO_CONN_RECONNECT","1"),{logLevel:"info"});const e=async()=>new Promise((e=>{const t=setTimeout((()=>{e(!1)}),5e3);this.connectToServer(this.currentServer).then((n=>{clearTimeout(t),e(n)}))}));let t=await e();if(t)return t;const n=h(e,200),o=h(e,1e3),s=h(e,5e3),r=[n,n,o,o,o,s,s,s,h(e,35e3)];for(let e=0;e<r.length;e++)t||(this.sdkInstance.log(d("INFO_CONN_RECONNECT",(e+2).toString()),{logLevel:"info"}),t=await r[e](this.currentServer),t||this.sdkInstance.log(d("INFO_CONN_RECONNECT_ATTEMPT_FAILED",(e+2).toString()),{logLevel:"info"}));return t}async firstConnection(e){for(const t of e){this.sdkInstance.log(d("INFO_CONN_CONNECT",t),{logLevel:"info"});if(await this.connectToServer(t))return this.sdkInstance.log(d("INFO_CONN_CONNECT_SUCCESSFUL",t),{logLevel:"info"}),this.currentServer=t,!0}return!1}async connectToServer(e){const t=this.makeConnectionURL(e),n=this.connectionConstructor?this.connectionConstructor():new u,o=await n.connect(t);return o?(this.transportList.add(n),this.sdkInstance.log(d("INFO_CONN_TRANSPORT_CONNECTED",n.uuid),{logLevel:"info"}),n.messageHandler=this.messageHandler,n.onClose=this.onTransportClose,await new Promise((e=>{this.awaitingTransportHandler&&(this.awaitingTransportHandler.resolve(!1),this.destroyTransportSilent(this.awaitingTransportHandler.transport)),this.awaitingTransportHandler={resolve:e,transport:n}}))):(n.destroy(c),o)}async clearRoutine(e){if(0===this.state||3===this.state||5===this.state)return void this.sdkInstance.log(d("WARN_CONN_WRONG_STATE","disconnect",s[this.state],""+this.state),{logLevel:"warning"});this.sdkInstance.log(d("INFO_CONN_CLEAR"),{logLevel:"info"}),this.state=5;const t={type:"close",seq:this.localClock++};this.transportList.forEach((n=>{2===n.state&&e&&n.send(JSON.stringify(t)),this.destroyTransportSilent(n)}))}destroyTransportSilent(e){this.transportList.delete(e),e.onClose=null,e.messageHandler=null,e.destroy(),this.sdkInstance.log(d("INFO_CONN_TRANSPORT_DESTROY",e.uuid),{logLevel:"info"})}}e([o("ConnectionStateChanged")],m.prototype,"state",void 0),e([function(e=200){let t,n;return(o,s,r)=>({value:function(...o){var s;t||(t=Date.now()),global.clearTimeout(n),t&&Date.now()-t>=e?(null===(s=r.value)||void 0===s||s.apply(this,o),t=Date.now()):n=global.setTimeout((()=>{var n;Date.now()-t>=e&&(null===(n=r.value)||void 0===n||n.apply(this,o),t=Date.now())}),e-(Date.now()-t))}})}(5e3)],m.prototype,"sendACK",null);const E={major:5,minor:0,rev:0};let C=null;const p=function(){},R=new Set;let f;const T=function(e){for(const t of R){const n=t.eventFactory(e);if(n)return n}};function v(){return(null==f?void 0:f.state)||0}let S,y;const A={registerModule:function(e,t,n){R.add({eventFactory:e,preHandler:t,postHandler:n})},clear:()=>{R.clear()},login:async function(e){return 0!==e.state&&3!==e.state?{result:!1,code:-7,reason:d("ERR_AlREADY_AUTHORIZED")}:(S=e,e.auth(A))},send:async function(e,t){if(null==t?void 0:t.toGW)return f?void("chat"===(null==e?void 0:e.service)?await f.send(e):await f.send({name:e.name,params:O(e.name,e.params)})):(y.log(d("ERR_NOT_CONNECTED_YET"),{logLevel:"error"}),Promise.reject(d("ERR_NOT_CONNECTED_YET")));const n=T(e);if(n){const e=Object.assign({},n);delete e.handler;for(const t of R)if(t.preHandler)try{await t.preHandler(e)}catch(t){y&&y.log(d("ERR_CORE_PRE_HANDLER_THROW",e.name,t.message),{logLevel:"error"})}try{await n.handler(e)}catch(t){y&&y.log(d("ERR_CORE_HANDLER_THROW",e.name,t.message),{logLevel:"error"})}for(const t of R)if(t.postHandler)try{await t.postHandler(e)}catch(t){y&&y.log(d("ERR_CORE_POST_HANDLER_THROW",e.name,t.message),{logLevel:"error"})}}else y&&y.log(d("WARN_CORE_WRONG_EVENT",e.name),{logLevel:"warning"})},connect:async function(){var e;5===v()||0===v()?(f=new m(y,null===(e=C)||void 0===e?void 0:e.connection),await f.connect()):y&&y.log(d("ERR_AlREADY_CONNECTED"),{logLevel:"error"})},disconnect:async function(){if(f)return f.clear();y&&y.log(d("ERR_NOT_CONNECTED_YET"),{logLevel:"error"})},connectionState:v,loginState:function(){return(null==S?void 0:S.state)||0},username:function(){return(null==S?void 0:S.username)||"unknown"},setSdk:function(e){y=e}};function I(e){return"number"==typeof(null==e?void 0:e.major)&&"number"==typeof(null==e?void 0:e.minor)&&"number"==typeof(null==e?void 0:e.rev)}const w=(e,{minor:t,major:n,rev:o,comparator:s})=>{const r={minor:t,major:n,rev:o};if(!I(e)||!I(r)||!function(e){return["strict","less","grater","lessOrEqual","graterOrEqual","sameMajor","sameMinor"].includes(e)}(s))return null;switch(s){case"strict":return D(e,r);case"grater":return L(e,r);case"less":return L(r,e);case"graterOrEqual":return D(e,r)||L(e,r);case"lessOrEqual":return D(r,e)||L(r,e);case"sameMajor":return k(e,r);case"sameMinor":return b(e,r)}},L=(e,t)=>e.major>t.major||k(e,t)&&e.minor>t.minor||b(e,t)&&e.rev>t.rev,D=(e,t)=>e.major===t.major&&e.minor===t.minor&&e.rev===t.rev,k=(e,t)=>e.major===t.major,b=(e,t)=>e.major===t.major&&e.minor===t.minor,W={NOT_CONFIGURED:"notConfigured",DISCONNECTED:"disconnected",CONNECTING:"connecting",CONNECTED:"connected",AUTHORIZING:"authorizing",AUTHORIZED:"authorized",AUTHORIZATION_FAILED:"authorizationFailed",CONNECTION_FAILED:"connectionFailed",RECONNECTING:"reconnecting",UNKNOWN:"unknown"};function j(e){return{name:e}}const F={major:5,minor:0,rev:0},P={require:{core:{major:5,minor:0,rev:0,comparator:"graterOrEqual"}}},{addEventListener:H,removeEventListener:M,dispatchEvent:G}=function(e){const t={},n=function(t){return!e||Object.values(e).some((e=>e===t))},o=function(e,o){n(e)&&t[e.name]&&(t[e.name]=t[e.name].filter((e=>e.listener!==o)))};return{addEventListener:function(e,s,r){var a;n(e)&&(a=e.name,t[a]||(t[a]=[]),r&&r.signal&&(r.signal.onabort=function(){o(e,s)}),t[e.name].push({once:r&&r.once||!1,fulfilled:!1,listener:s}))},removeEventListener:o,dispatchEvent:function(e){const n=e.type.name;t[n]&&t[n].forEach((t=>{t.once&&t.fulfilled||t.listener(e),t.fulfilled=!0}))}}}(),U=j("loginSuccessful"),q=j("loginFailed"),x={"GW.loginSuccessful":U,"GW.loginFailed":q},K=function(e){const t=["GW.loginSuccessful","GW.loginFailed"];function n(t){const n={timeStamp:Date.now(),target:e,type:x[t.name]};G(Object.assign(Object.assign({},t),n))}e.registerModule((e=>"AuthStateChanged"===e.name?Object.assign(Object.assign({},e),{handler:e=>{}}):!!t.includes(e.name)&&Object.assign(Object.assign({},e),{handler:n})))},$={receiveCalls:!0};function V(e,t,n="string"==typeof e){"string"==typeof e&&(e=e.split(""));let o=e.map(((n,o)=>o%t==0?Array.from(Array(t).keys()).map((t=>e[o+t])):[])).filter((e=>e.length>0));return n&&(o=o.map((e=>e.join("")))),o}function Y(e,t,n,o=!0,s=Array.isArray(e)){let r;r=Array.isArray(e)?e:e.split("");const a=function(...e){const t=1===e.length?0:e[0],n=2===e.length?e[1]:e[0]-1;return Array.from(Array(n-t+1).keys()).map((e=>e+t))}(t-e.length).map((()=>n)),i=o?r.concat(a):a.concat(r);return s?i:i.join("")}function B(e){return V(Y(e.toString(16),8,"0",!1),2).reverse().join("")}function Z(e){return e.split("").map((e=>function(e){let t="";const n=e.charCodeAt(0);n<128?t+=String.fromCharCode(n):n>127&&n<2048?(t+=String.fromCharCode(n>>6|192),t+=String.fromCharCode(63&n|128)):(t+=String.fromCharCode(n>>12|224),t+=String.fromCharCode(n>>6&63|128),t+=String.fromCharCode(63&n|128));return t}(e))).join("")}function z(...e){const t=Uint32Array.from([0]);return Uint32Array.from(e).forEach((e=>t[0]=t[0]+e)),t[0]}function J(e,t,n){return e&t|~e&n}function Q(e,t,n){return e&n|t&~n}function X(e,t,n){return e^t^n}function ee(e,t,n){return t^(e|~n)}const te=[7,12,17,22,7,12,17,22,7,12,17,22,7,12,17,22,5,9,14,20,5,9,14,20,5,9,14,20,5,9,14,20,4,11,16,23,4,11,16,23,4,11,16,23,4,11,16,23,6,10,15,21,6,10,15,21,6,10,15,21,6,10,15,21];function ne(e){return Math.floor(Math.pow(2,32)*Math.abs(Math.sin(e+1)))}function oe(e){return e>=0&&e<=15?e:e>=16&&e<=31?(5*e+1)%16:e>=32&&e<=47?(3*e+5)%16:e>=48&&e<=63?7*e%16:0}function se(e){const t=e.length,n=63-(t+8)%64,o=Y((e+=String.fromCharCode(128)).split(""),t+1+n,String.fromCharCode(0)),s=V(Y(function(e,t=8,n=Math.pow(2,t)-1){if(e<0)throw new Error("code should be greater than: 0");if(e>n)throw new Error("code should be less than: "+n);return Y(e.toString(2),t,"0",!1)}(8*t%Math.pow(2,64),64),64,"0"),8).reverse().map((e=>parseInt(e,2))),r=o.map((e=>e.charCodeAt(0)));return Uint32Array.from(V(r.concat(s),4).map((e=>e.map((e=>Y(e.toString(16),2,"0",!1))).join(""))).map((e=>parseInt(e,16))).map((e=>parseInt(B(e),16))))}function re(e){return t=function(e){return e>=0&&e<=15?J:e>=16&&e<=31?Q:e>=32&&e<=47?X:e>=48&&e<=63?ee:void 0}(e),(e,n,o,s,r,a,i)=>{return z((c=z(e,t(n,o,s),r,i))<<(l=a)|c>>>32-l,n);var c,l};var t}class ae{constructor({username:e,password:t,options:n}){this.state=0,this.username=e,this.password=t,this.options=n||$}auth(e){return this.state=1,new Promise(((t,n)=>{H(q,(e=>{this.state=3,n({code:e.code,result:!1,reason:e.extra})}),{once:!0}),H(U,(({displayName:n,params:o})=>{const{iceConfig:s,OAuth:r,connectionId:a}=o;this.state=2,e.send({name:"WebRTC.iceConfig",params:{iceConfig:s}},{toGW:!1}),t({result:!0,OAuth:r,connectionId:a,displayName:n})}),{once:!0});const o=function(e){const t=se(e=Z(e)),n=Uint32Array.from([1732584193,4023233417,2562383102,271733878]),o=V(Array.from(t),16);for(const e of o){const t=n[0],o=n[1],s=n[2],r=n[3];for(let t=0;t<64;t++)n[(4-t%4)%4]=re(t)(n[(4-t%4)%4],n[(4-t%4+1)%4],n[(4-t%4+2)%4],n[(4-t%4+3)%4],e[oe(t)],te[t],ne(t));n[0]=t+n[0],n[1]=o+n[1],n[2]=s+n[2],n[3]=r+n[3]}return Array.from(n).map((e=>B(e))).join("").toLowerCase()}(`${this.username.split("@")[0]}:voximplant.com:${this.password}`);e.send({name:"login",params:{username:this.username,password:o,options:Object.assign(Object.assign({},this.options),{credentialType:"md5"})}},{toGW:!0})}))}}e([o("AuthStateChanged")],ae.prototype,"state",void 0);const ie=j("configured"),ce=j("connected"),le=j("connection_failed"),de=j("disconnected"),ue=j("auth_success"),he=j("auth_failed");var ge=Object.freeze({__proto__:null,Configured:ie,Connected:ce,ConnectionFailed:le,Disconnected:de,AuthSuccess:ue,AuthFailed:he});class Ne{constructor({username:e,onOneTimeLoginKey:t,options:n}){this.state=0,this.username=e,this.onOneTimeLoginKey=t,this.options=n||$}auth(e){return new Promise(((t,n)=>{this.state=1,H(q,(async t=>{if(302!=t.code)return this.state=3,void n({code:t.code,result:!1,reason:t.extra});const o=await this.onOneTimeLoginKey(t.extra);await e.send({name:"loginUsingOneTimeKey",params:{username:this.username,hash:o,options:this.options}},{toGW:!0})})),H(U,(({displayName:n,params:o})=>{const{iceConfig:s,OAuth:r,connectionId:a}=o;this.state=2,e.send({name:"WebRTC.iceConfig",params:{iceConfig:s}},{toGW:!1}),t({result:!0,OAuth:r,connectionId:a,displayName:n})}),{once:!0}),e.send({name:"loginGenerateOneTimeKey",params:{username:this.username}},{toGW:!0})}))}}e([o("AuthStateChanged")],Ne.prototype,"state",void 0);let Oe,_e={};const me={logLevel:"none",applicationName:"",connectionId:"",callId:"",customerName:"",metaRay:r(),deviceId:"",serverCallId:"",sessionId:"",userName:""},Ee={},Ce={};async function pe(e){if(Object.keys(Ee).includes(e.name))return Re(`Module "${e.name}" already loaded. Skipped...`,{logLevel:"warning"}),null;let t=!0,n=!0;if(e.dependencies.require&&(t=Object.entries(e.dependencies.require).every((t=>{const n=Ee[t[0]]&&w(Ee[t[0]],t[1]);return n||Re(d("WARN_CORE_UNMET_DEP",e.name,e.version.major.toString(),e.version.minor.toString(),e.version.rev.toString(),t[0],t[1].major.toString(),t[1].minor.toString(),t[1].rev.toString()),{logLevel:"warning"}),n}))),e.dependencies.conflicts&&(n=!Object.entries(e.dependencies.conflicts).some((t=>{const n=Ee[t[0]]&&w(Ee[t[0]],t[1]);return n&&Re(d("WARN_CORE_CONFLICT_DEP",e.name,e.version.major.toString(),e.version.minor.toString(),e.version.rev.toString(),t[0],t[1].major.toString(),t[1].minor.toString(),t[1].rev.toString()),{logLevel:"warning"}),n}))),n&&(n=!Object.entries(Ce).some((t=>t[0]===e.name&&w(e.version,t[1])))),!t||!n)return null;Re(`Module "${e.name}" v${e.version.major}.${e.version.minor}.${e.version.rev} has no conflicts. Running module setup.`,{logLevel:"info"}),e.dependencies.conflicts&&Object.entries(e.dependencies.conflicts).forEach((e=>{Ce[e[0]]=e[1]})),await e.setup(Oe),Re(`Module "${e.name}" v${e.version.major}.${e.version.minor}.${e.version.rev} was setup and loaded.`,{logLevel:"info"}),Ee[e.name]=e.version}function Re(e,t){_e.logger&&Object.keys(_e.logger).includes("commonSettings")&&_e.logger.writeLog(e,Object.assign(Object.assign({},me),t))}const fe={configure:async function(e={}){const t=function(e){return e.environment&&!["development","production"].includes(e.environment)?{result:!1,exception:Error(d("THROW_WRONG_ENVIRONMENT"))}:e.modules&&!Array.isArray(e.modules)&&"function"!=typeof e.modules?{result:!1,exception:Error(d("THROW_WRONG_MODULES_CONSTRUCTOR"))}:{result:!0}}(e);if(!t.result)throw t.exception;if(_e=Object.assign(Object.assign({},{environment:"production"}),e),Oe||(await pe(function(e){return C=e,{dependencies:{},name:"core",setup:p,version:E}}(e)),Oe=A,A.setSdk(fe),await pe({dependencies:P,name:"auth",setup:K,version:F})),_e.deviceId&&(me.deviceId=_e.deviceId),_e.logger&&("function"==typeof _e.logger&&(_e.logger=await _e.logger()),_e.logger=_e.logger.setup(Oe)),Re("Logger initialized",{logLevel:"trace"}),_e.modules){const e=Array.isArray(_e.modules)?_e.modules:await _e.modules();if(Array.isArray(e))for(const t of e)try{await pe(t)}catch(e){Re(d("ERR_LOADING_MODULE")+e.message,{logLevel:"error"})}else Re(d("ERR_MODULE_CONSTRUCTOR"),{logLevel:"error"})}},clear:function(){0!==Object.keys(_e).length&&(_e={},Object.keys(Ee).forEach((e=>{delete Ee[e]})),Object.keys(Ce).forEach((e=>{delete Ce[e]})),Oe.clear())},log:Re,connect:async()=>Oe.connect(),login:async e=>{if(Oe)return Oe.login(e);throw new Error("Not configured")},state:W.UNKNOWN,config:_e,version:"5.0.0-alpha0"};Object.defineProperty(fe,"state",{get:function(){const e=Oe.connectionState(),t=Oe.loginState();return 0===Object.keys(_e).length?W.NOT_CONFIGURED:((e,t)=>{switch(e){case 0:return W.DISCONNECTED;case 1:return W.CONNECTING;case 2:switch(t){case 0:return W.CONNECTED;case 1:return W.AUTHORIZING;case 2:return W.AUTHORIZED;case 3:return W.AUTHORIZATION_FAILED}break;case 3:return W.CONNECTION_FAILED;case 4:return W.RECONNECTING;case 5:return W.DISCONNECTED}return W.UNKNOWN})(e,t)},set:function(){Re(d("ERR_STATE_IS_READONLY"),{logLevel:"error"})}}),Object.defineProperty(fe,"config",{get:function(){return _e},set:function(){Re(d("ERR_CONFIG_IS_READONLY"),{logLevel:"error"})}});const Te={PasswordAuth:ae,OtpAuth:Ne};export{ge as Events,fe as SDK,W as SDKState,Te as auth};
//# sourceMappingURL=index.esm.min.js.map
