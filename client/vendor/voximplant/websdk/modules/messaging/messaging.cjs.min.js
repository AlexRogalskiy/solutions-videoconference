"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e;!function(e){e.createConversation="createConversation",e.editConversation="editConversation",e.removeConversation="removeConversation",e.joinConversation="joinConversation",e.leaveConversation="leaveConversation",e.getConversation="getConversation",e.getConversations="getConversations",e.getPublicConversations="getPublicConversations",e.searchConversations="searchConversations",e.removeEmptyConversation="removeEmptyConversation",e.addParticipants="addParticipants",e.editParticipants="editParticipants",e.removeParticipants="removeParticipants",e.getUser="getUser",e.getUsers="getUsers",e.editUser="editUser",e.setStatus="setStatus",e.sendMessage="sendMessage",e.editMessage="editMessage",e.removeMessage="removeMessage",e.typingMessage="typingMessage",e.isRead="isRead",e.subscribe="subscribe",e.unsubscribe="unsubscribe",e.manageNotification="manageNotification",e.getSubscriptionList="getSubscriptionList",e.createBot="createBot",e.removeBot="removeBot",e.retransmitEvents="retransmitEvents",e.UNKNOWN="UNKNOWN"}(e||(e={}));const t={error_0:{code:0,description:"Something went wrong. Please check your input or required parameters."},error_1:{code:1,description:"Transport description structure is wrong. From GW."},error_2:{code:2,description:"Event name is unknown."},error_3:{code:3,description:"User is not authorized. From GW."},error_8:{code:8,description:"Conversation does not exist."},error_10:{code:10,description:"Message with this UUID does not exist in the conversation."},error_11:{code:11,description:"Message with this UUID is deleted from the conversation."},error_12:{code:12,description:"ACL error."},error_13:{code:13,description:"User is already in the participants list."},error_15:{code:15,description:"Public join is not available for this conversation."},error_16:{code:16,description:"Conversation with this UUID is deleted."},error_18:{code:18,description:"User validation error."},error_19:{code:19,description:"User is not in the participants list."},error_21:{code:21,description:"Number of requested objects is 0 or larger than allowed by the service."},error_22:{code:22,description:"Number of requested objects is larger than allowed by the service."},error_23:{code:23,description:"Message size exceeds the limit of 5000 symbols."},error_24:{code:24,description:"The 'seq' parameter value is greater than currently possible."},error_25:{code:25,description:"User is not found."},error_26:{code:26,description:"The notification event is incorrect."},error_28:{code:28,description:"The 'from' field value is greater than the 'to' field value."},error_30:{code:30,description:"Messaging service is not available. Try again later. From GW."},error_32:{code:32,description:"N descriptions per second limit reached. Please try again later. From GW."},error_33:{code:33,description:"N descriptions per minute limit reached. Please try again later. From GW."},error_34:{code:34,description:"Direct conversation cannot be public or uber."},error_35:{code:35,description:"Direct conversation is allowed between two users only."},error_36:{code:36,description:"Passing the 'eventsFrom', 'eventsTo' and 'count' parameters simultaneously is not allowed. You should use only two of them."},error_37:{code:37,description:"Adding participant to a direct conversation is not allowed."},error_38:{code:38,description:"Removing participant from a direct conversation is not allowed."},error_39:{code:39,description:"Joining a direct conversation is not allowed."},error_40:{code:40,description:"Leaving a direct conversation is not allowed."},error_41:{code:41,description:"Specify at least two parameters: eventsFrom, eventsTo or count."},error_42:{code:42,description:"Current messaging tier has been exceeded."},error_43:{code:43,description:"Messaging tier is being upgraded. Please try again later."},error_201:{code:201,description:"You can get maximum 30 conversation in a single getConversations call."},error_500:{code:500,description:"Internal error."}};var s;!function(e){e.onError="onError",e.onCreateConversation="onCreateConversation",e.onEditConversation="onEditConversation",e.onRemoveConversation="onRemoveConversation",e.onGetConversation="onGetConversation",e.onGetPublicConversations="onGetPublicConversations",e.onGetUser="onGetUser",e.onEditUser="onEditUser",e.onSetStatus="onSetStatus",e.onSendMessage="onSendMessage",e.onEditMessage="onEditMessage",e.onRemoveMessage="onRemoveMessage",e.isRead="isRead",e.isDelivered="isDelivered",e.onTyping="onTyping",e.onSubscribe="onSubscribe",e.onUnsubscribe="onUnsubscribe",e.onGetSubscriptionList="onGetSubscriptionList",e.onCreateBot="onCreateBot",e.onRemoveBot="onRemoveBot",e.onRetransmitEvents="onRetransmitEvents"}(s||(s={}));class r extends Error{constructor(e,t){super(e),this.code=t}}function n(e){return e<0?NaN:e<=30?0|Math.random()*(1<<e):e<=53?(0|Math.random()*(1<<30))+(0|Math.random()*(1<<e-30))*(1<<30):NaN}function o(e,t){let s=e.toString(16),r=t-s.length,n="0";for(;r>0;r>>>=1,n+=n)1&r&&(s=n+s);return s}const i=e=>e.toString()[0].toUpperCase()+e.toString().slice(1);function a(e){return{name:e}}const c=a("MessageReceived"),d=a("EditConversation"),u=a("UsersAdded"),l=a("UsersRemoved");var p=Object.freeze({__proto__:null,MessageReceived:c,EditConversation:d,UsersAdded:u,UsersRemoved:l});const v=2e4,m=200,g=new Map;let h;const b=e=>g.get(e),y=(e,t)=>{g.set(e,t)},_=()=>h;function f(e){if(Object.values(s).includes(e.event)){const s=P.get(e.request_uuid);if(s)"onError"===e.event?e.handler=e=>s.reject((()=>{P.delete(e.request_uuid),global.clearTimeout(s.expire);const n=t["error_"+e.payload.code];return new r(n.description,n.code)})()):w[e.request_uuid]?e.handler=w[e.request_uuid]:e.event===s.successEvt&&(e.handler=t=>{const r=C(t,s);if(r.type=c,"onSendMessage"===e.event){const e=b(r.message.conversation);null==e||e.dispatchEvent(r)}s.resolve(r)});else switch(e.event){case"onSendMessage":e.handler=e=>{const t=M(e);t.type=c;const s=b(t.message.conversation);null==s||s._onSendMessage(t)};break;case"onEditConversation":e.handler=e=>{const t=M(e);t.type=d;const s=b(t.conversation.uuid);null==s||s._onEditConversation(t)};break;default:e.handler=e=>M(e)}return e}return!1}function C(e,t){const s=Array.isArray(e)?e[0].requestUuid:e.requestUuid;return P.delete(s),global.clearTimeout(t.expire),Array.isArray(e)?e.map((e=>M(e,t))):M(e,t)}function M(e,s){var n,o,i;"type/vox.store.CallbackMessage"===(null===(n=e.payload)||void 0===n?void 0:n.object["@type"])&&(e=e.payload.object);const a={initiator:e.payload.initiator,messengerAction:e.payload.on_incoming_event,name:e.name,requestUuid:e.request_uuid,timestamp:0|(null===(o=e.payload)||void 0===o?void 0:o.timestamp)},c={"type/vox.store.CallbackNamespace.UserData":{entity:"user",transformer:U},"type/vox.store.CallbackNamespace.Conversation":{entity:"conversation",transformer:U},"type/vox.store.CallbackNamespace.Message":{entity:"message",transformer:U},"type/vox.store.CommonNamespace.PresenceMessage":{entity:"online",transformer:e=>e.online}}[null===(i=e.payload)||void 0===i?void 0:i.object["@type"]];if(!c){const e=t.error_500;return null==s?void 0:s.reject(new r(e.description,e.code))}return a[c.entity]=c.transformer(e.payload.object),"conversation"===c.entity&&(a.conversation.lastSeq=e.payload.seq),"message"===c.entity&&(a.message.seq=e.payload.seq),a}function U(e){delete e["@type"],delete e.vox_info;const t={};for(const[r,n]of Object.entries(e))t[(s=r,s.split("_").reduce(((e,t,s)=>e+(s>0?i(t):t))))]=n;var s;return t}const P=new Map,w={};function E(e){const t=[],s=function(e,t=200){let s;return function(...r){clearTimeout(s),s=setTimeout((()=>e.apply(this,r)),t)}}((function(){e(t)}),m);return function(e){t.push(e),s()}}const S=(t,r)=>{const n=new Map([[e.getUsers,s.onGetUser],[e.getConversations,s.onGetConversation],[e.getPublicConversations,s.onGetPublicConversations],[e.retransmitEvents,s.onRetransmitEvents]]),o=n.has(t),a=j(t,r);return new Promise(((s,r)=>{const c=global.setTimeout((()=>r),v);var d;const u={successEvt:o?n.get(t):"on"+i((d=t)===e.joinConversation?e.editConversation:d),remoteFunction:t,resolve:s,reject:r,expire:c};P.set(a,u),o&&(w[a]=E((e=>s(C(e,u)))))}))},j=(e,t)=>{const s=["subscribe","unsubscribe","typingMessage","isRead","setStatus"].includes(e)?"CommonNamespace":"IncomingNamespace",r=(null===(a=global.crypto)||void 0===a?void 0:a.randomUUID)?global.crypto.randomUUID():o(n(32),8)+"-"+o(n(16),4)+"-"+o(16384|n(12),4)+"-"+o(32768|n(14),4)+"-"+o(n(48),12);var a;const c={service:"chat",name:e,event:e,payload:Object.assign(t,{"@type":`type/vox.store.${s}.${{setStatus:"PresenceMessage",isRead:"StatusMessage",typingMessage:"TypingMessage",subscribe:"ManageSubscribes",unsubscribe:"ManageSubscribes",addParticipants:"ManageParticipants",editParticipants:"ManageParticipants",manageNotification:"ManageNotifications",getPublicConversations:"GetConversations",retransmitEvents:"RetransmitRequest"}[e]||i(e)}`}),request_uuid:r};return _().send(c,{toGW:!0}),r};class x{constructor(e){this.uuid=e.message.uuid,this.conversation=e.message.conversation,this.text=e.message.text,this.payload=e.message.payload,this.sender=e.initiator,this.timestamp=e.timestamp?e.timestamp:0,this.seq=e.message.seq}async edit(t,s){const r=await S(e.editMessage,{uuid:this.uuid,conversation:this.conversation,text:t,payload:s});return this._update(r),Promise.resolve(this)}async remove(){return await S(e.removeMessage,{uuid:this.uuid,conversation:this.conversation}),Promise.resolve()}_update(e){this.uuid=e.message.uuid,this.text=e.message.text,this.payload=e.message.payload,this.timestamp=e.timestamp?e.timestamp:0,this.seq=e.message.seq}}const q=function(e){const t={},s=function(t){return!e||Object.values(e).some((e=>e===t))},r=function(e,r){s(e)&&t[e.name]&&(t[e.name]=t[e.name].filter((e=>e.listener!==r)))};return{addEventListener:function(e,n,o){var i;s(e)&&(i=e.name,t[i]||(t[i]=[]),o&&o.signal&&(o.signal.onabort=function(){r(e,n)}),t[e.name].push({once:o&&o.once||!1,fulfilled:!1,listener:n}))},removeEventListener:r,dispatchEvent:function(e){const s=e.type.name;t[s]&&t[s].forEach((t=>{t.once&&t.fulfilled||t.listener(e),t.fulfilled=!0}))}}};class R extends class{constructor(){const e=q();this.addEventListener=e.addEventListener,this.removeEventListener=e.removeEventListener,this.dispatchEvent=e.dispatchEvent}}{constructor(e){super(),this.customData={},this.direct=!1,this.participants=[],this.enablePublicJoin=!1,this.title="",this.uberConversation=!1,this.uuid="",this.createdAt=0,this.lastSeq=0,this.lastUpdate=0,this._update(e)}_update(e){this.customData=e.customData,this.direct=e.direct,this.participants=e.participants,this.enablePublicJoin=e.enablePublicJoin,this.title=e.title,this.uberConversation=e.uberConversation,this.uuid=e.uuid,this.createdAt=e.createdAt,this.lastSeq=e.lastSeq,this.lastUpdate=e.lastUpdate}_serializeToPayload(){return{participants:this._serializeParticipants(this.participants).map((e=>Object.assign(e,{flags:e.flags?e.flags:7}))),title:this.title,direct:this.direct,enable_public_join:this.enablePublicJoin,uber_conversation:this.uberConversation,custom_data:this.customData}}_onSendMessage(e){this.dispatchEvent({type:c,target:this,timeStamp:Date.now(),message:new x(e)})}_onEditConversation(e){if("joinConversation"===e.messengerAction){const t=this.participants.map((e=>e.user_id)),s=e.conversation.participants.filter((e=>!t.includes(e.user_id)));this.participants=[...this.participants,...s],this.dispatchEvent({type:u,target:this,timeStamp:Date.now(),usersId:s.map((e=>e.user_id))})}else this.dispatchEvent({type:d,target:this,timeStamp:Date.now()})}_serializeParticipants(e){return e.map((e=>({user_id:e.userId,flags:this._getUserPermissions(e),last_read:e.lastRead})))}_getUserPermissions(e){const t=(e.isOwner?"1000000000":"")+[e.canRemoveAll,e.canEditAll,e.canManageParticipants,e.canRemove,e.canEdit,e.canWrite].map((e=>e?1:0)).join("");return parseInt(t,2)}retransmitEvents(s,n){return"number"!=typeof s||"number"!=typeof n?Promise.reject(new r(t.error_0.description,t.error_0.code)):S(e.retransmitEvents,{conversation:this.uuid,events_to:s,count:n})}async sendMessage(s,n){if("string"!=typeof s&&!(void 0!==n||Array.isArray(n)&&n.every((e=>e&&"object"==typeof e))))return Promise.reject(new r(t.error_0.description,t.error_0.code));const o=await S(e.sendMessage,{text:s,conversation:this.uuid,payload:n});return new x(o)}}function N(){return(e=>{if(-1===e.indexOf("@"))return e;{const t=e.split("@");return t[1]=t[1].split(".").splice(0,2).join("."),t.join("@")}})(_().username())}function A(t){return S(e.getUser,{user_name:t})}function G(e){let t=b(e.conversation.uuid);return t?t._update(e.conversation):(t=new R(e.conversation),y(e.conversation.uuid,t)),t}const D={getMe:N,getMyId:function(){return A(N()).then((e=>e.user.userId))},getUserById:function(t){return S(e.getUser,{user_id:t})},getUsersById:function(s){if(!Array.isArray(s))return Promise.reject(new r(t.error_0.description,t.error_0.code));const n=s.map((e=>({user_id:e})));return S(e.getUsers,{users:n})},getUser:A,getUsers:function(s){if(!Array.isArray(s))return Promise.reject(new r(t.error_0.description,t.error_0.code));const n=s.map((e=>({user_name:e})));return S(e.getUsers,{users:n})},editUser:function(t,s){const r={};return t&&(r.custom_data=t),s&&(r.private_custom_data=s),S(e.editUser,r)},setStatus:function(t){return S(e.setStatus,{online:t})},createConversation:async function(t){const s=new R(t),r=await S(e.createConversation,s._serializeToPayload());return y(r.conversation.uuid,s),s._update(r.conversation),Promise.resolve(s)},getConversation:async function(t){const s=await S(e.getConversation,{uuid:t});return Promise.resolve(G(s))},joinConversation:async function(t){const s=await S(e.joinConversation,{uuid:t});return Promise.resolve(G(s))},getConversations:async function(s){if(Array.isArray(s)&&s.length>30)return Promise.reject(new r(t.error_201.description,t.error_201.code));const n=(await S(e.getConversations,{uuid:s})).map((e=>G(e)));return Promise.resolve(n)},getPublicConversations:async function(){const t=(await S(e.getPublicConversations,{})).map((e=>G(e)));return Promise.resolve(t)}},T={major:5,minor:0,rev:0};let I;const L=function(e){I=e,(e=>{h=e})(e),I.registerModule(f)};exports.Events=p,exports.Messaging=D,exports.MessagingLoader=function(){return{dependencies:{},name:"messaging",setup:L,version:T}};
//# sourceMappingURL=messaging.cjs.min.js.map
