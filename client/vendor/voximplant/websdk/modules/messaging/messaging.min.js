this.Voximplant=this.Voximplant||{},this.Voximplant.messaging=function(e){"use strict";var t;!function(e){e.createConversation="createConversation",e.editConversation="editConversation",e.removeConversation="removeConversation",e.joinConversation="joinConversation",e.leaveConversation="leaveConversation",e.getConversation="getConversation",e.getConversations="getConversations",e.getPublicConversations="getPublicConversations",e.searchConversations="searchConversations",e.removeEmptyConversation="removeEmptyConversation",e.addParticipants="addParticipants",e.editParticipants="editParticipants",e.removeParticipants="removeParticipants",e.getUser="getUser",e.getUsers="getUsers",e.editUser="editUser",e.setStatus="setStatus",e.sendMessage="sendMessage",e.editMessage="editMessage",e.removeMessage="removeMessage",e.typingMessage="typingMessage",e.isRead="isRead",e.subscribe="subscribe",e.unsubscribe="unsubscribe",e.manageNotification="manageNotification",e.getSubscriptionList="getSubscriptionList",e.createBot="createBot",e.removeBot="removeBot",e.retransmitEvents="retransmitEvents",e.UNKNOWN="UNKNOWN"}(t||(t={}));const s={error_0:{code:0,description:"Something went wrong. Please check your input or required parameters."},error_1:{code:1,description:"Transport description structure is wrong. From GW."},error_2:{code:2,description:"Event name is unknown."},error_3:{code:3,description:"User is not authorized. From GW."},error_8:{code:8,description:"Conversation does not exist."},error_10:{code:10,description:"Message with this UUID does not exist in the conversation."},error_11:{code:11,description:"Message with this UUID is deleted from the conversation."},error_12:{code:12,description:"ACL error."},error_13:{code:13,description:"User is already in the participants list."},error_15:{code:15,description:"Public join is not available for this conversation."},error_16:{code:16,description:"Conversation with this UUID is deleted."},error_18:{code:18,description:"User validation error."},error_19:{code:19,description:"User is not in the participants list."},error_21:{code:21,description:"Number of requested objects is 0 or larger than allowed by the service."},error_22:{code:22,description:"Number of requested objects is larger than allowed by the service."},error_23:{code:23,description:"Message size exceeds the limit of 5000 symbols."},error_24:{code:24,description:"The 'seq' parameter value is greater than currently possible."},error_25:{code:25,description:"User is not found."},error_26:{code:26,description:"The notification event is incorrect."},error_28:{code:28,description:"The 'from' field value is greater than the 'to' field value."},error_30:{code:30,description:"Messaging service is not available. Try again later. From GW."},error_32:{code:32,description:"N descriptions per second limit reached. Please try again later. From GW."},error_33:{code:33,description:"N descriptions per minute limit reached. Please try again later. From GW."},error_34:{code:34,description:"Direct conversation cannot be public or uber."},error_35:{code:35,description:"Direct conversation is allowed between two users only."},error_36:{code:36,description:"Passing the 'eventsFrom', 'eventsTo' and 'count' parameters simultaneously is not allowed. You should use only two of them."},error_37:{code:37,description:"Adding participant to a direct conversation is not allowed."},error_38:{code:38,description:"Removing participant from a direct conversation is not allowed."},error_39:{code:39,description:"Joining a direct conversation is not allowed."},error_40:{code:40,description:"Leaving a direct conversation is not allowed."},error_41:{code:41,description:"Specify at least two parameters: eventsFrom, eventsTo or count."},error_42:{code:42,description:"Current messaging tier has been exceeded."},error_43:{code:43,description:"Messaging tier is being upgraded. Please try again later."},error_201:{code:201,description:"You can get maximum 30 conversation in a single getConversations call."},error_500:{code:500,description:"Internal error."}};var n;!function(e){e.onError="onError",e.onCreateConversation="onCreateConversation",e.onEditConversation="onEditConversation",e.onRemoveConversation="onRemoveConversation",e.onGetConversation="onGetConversation",e.onGetPublicConversations="onGetPublicConversations",e.onGetUser="onGetUser",e.onEditUser="onEditUser",e.onSetStatus="onSetStatus",e.onSendMessage="onSendMessage",e.onEditMessage="onEditMessage",e.onRemoveMessage="onRemoveMessage",e.isRead="isRead",e.isDelivered="isDelivered",e.onTyping="onTyping",e.onSubscribe="onSubscribe",e.onUnsubscribe="onUnsubscribe",e.onGetSubscriptionList="onGetSubscriptionList",e.onCreateBot="onCreateBot",e.onRemoveBot="onRemoveBot",e.onRetransmitEvents="onRetransmitEvents"}(n||(n={}));class r extends Error{constructor(e,t){super(e),this.code=t}}function o(e){return e<0?NaN:e<=30?0|Math.random()*(1<<e):e<=53?(0|Math.random()*(1<<30))+(0|Math.random()*(1<<e-30))*(1<<30):NaN}function i(e,t){let s=e.toString(16),n=t-s.length,r="0";for(;n>0;n>>>=1,r+=r)1&n&&(s=r+s);return s}const a=e=>e.toString()[0].toUpperCase()+e.toString().slice(1);function c(e){return{name:e}}const d=c("MessageReceived"),u=c("EditConversation"),l=c("UsersAdded"),p=c("UsersRemoved");var v=Object.freeze({__proto__:null,MessageReceived:d,EditConversation:u,UsersAdded:l,UsersRemoved:p});const m=2e4,g=200,h=new Map;let b;const y=e=>h.get(e),_=(e,t)=>{h.set(e,t)},f=()=>b;function C(e){if(Object.values(n).includes(e.event)){const t=w.get(e.request_uuid);if(t)"onError"===e.event?e.handler=e=>t.reject((()=>{w.delete(e.request_uuid),global.clearTimeout(t.expire);const n=s["error_"+e.payload.code];return new r(n.description,n.code)})()):E[e.request_uuid]?e.handler=E[e.request_uuid]:e.event===t.successEvt&&(e.handler=s=>{const n=M(s,t);if(n.type=d,"onSendMessage"===e.event){const e=y(n.message.conversation);null==e||e.dispatchEvent(n)}t.resolve(n)});else switch(e.event){case"onSendMessage":e.handler=e=>{const t=U(e);t.type=d;const s=y(t.message.conversation);null==s||s._onSendMessage(t)};break;case"onEditConversation":e.handler=e=>{const t=U(e);t.type=u;const s=y(t.conversation.uuid);null==s||s._onEditConversation(t)};break;default:e.handler=e=>U(e)}return e}return!1}function M(e,t){const s=Array.isArray(e)?e[0].requestUuid:e.requestUuid;return w.delete(s),global.clearTimeout(t.expire),Array.isArray(e)?e.map((e=>U(e,t))):U(e,t)}function U(e,t){var n,o,i;"type/vox.store.CallbackMessage"===(null===(n=e.payload)||void 0===n?void 0:n.object["@type"])&&(e=e.payload.object);const a={initiator:e.payload.initiator,messengerAction:e.payload.on_incoming_event,name:e.name,requestUuid:e.request_uuid,timestamp:0|(null===(o=e.payload)||void 0===o?void 0:o.timestamp)},c={"type/vox.store.CallbackNamespace.UserData":{entity:"user",transformer:P},"type/vox.store.CallbackNamespace.Conversation":{entity:"conversation",transformer:P},"type/vox.store.CallbackNamespace.Message":{entity:"message",transformer:P},"type/vox.store.CommonNamespace.PresenceMessage":{entity:"online",transformer:e=>e.online}}[null===(i=e.payload)||void 0===i?void 0:i.object["@type"]];if(!c){const e=s.error_500;return null==t?void 0:t.reject(new r(e.description,e.code))}return a[c.entity]=c.transformer(e.payload.object),"conversation"===c.entity&&(a.conversation.lastSeq=e.payload.seq),"message"===c.entity&&(a.message.seq=e.payload.seq),a}function P(e){delete e["@type"],delete e.vox_info;const t={};for(const[n,r]of Object.entries(e))t[(s=n,s.split("_").reduce(((e,t,s)=>e+(s>0?a(t):t))))]=r;var s;return t}const w=new Map,E={};function S(e){const t=[],s=function(e,t=200){let s;return function(...n){clearTimeout(s),s=setTimeout((()=>e.apply(this,n)),t)}}((function(){e(t)}),g);return function(e){t.push(e),s()}}const j=(e,s)=>{const r=new Map([[t.getUsers,n.onGetUser],[t.getConversations,n.onGetConversation],[t.getPublicConversations,n.onGetPublicConversations],[t.retransmitEvents,n.onRetransmitEvents]]),o=r.has(e),i=x(e,s);return new Promise(((s,n)=>{const c=global.setTimeout((()=>n),m);var d;const u={successEvt:o?r.get(e):"on"+a((d=e)===t.joinConversation?t.editConversation:d),remoteFunction:e,resolve:s,reject:n,expire:c};w.set(i,u),o&&(E[i]=S((e=>s(M(e,u)))))}))},x=(e,t)=>{const s=["subscribe","unsubscribe","typingMessage","isRead","setStatus"].includes(e)?"CommonNamespace":"IncomingNamespace",n=(null===(r=global.crypto)||void 0===r?void 0:r.randomUUID)?global.crypto.randomUUID():i(o(32),8)+"-"+i(o(16),4)+"-"+i(16384|o(12),4)+"-"+i(32768|o(14),4)+"-"+i(o(48),12);var r;const c={service:"chat",name:e,event:e,payload:Object.assign(t,{"@type":`type/vox.store.${s}.${{setStatus:"PresenceMessage",isRead:"StatusMessage",typingMessage:"TypingMessage",subscribe:"ManageSubscribes",unsubscribe:"ManageSubscribes",addParticipants:"ManageParticipants",editParticipants:"ManageParticipants",manageNotification:"ManageNotifications",getPublicConversations:"GetConversations",retransmitEvents:"RetransmitRequest"}[e]||a(e)}`}),request_uuid:n};return f().send(c,{toGW:!0}),n};class q{constructor(e){this.uuid=e.message.uuid,this.conversation=e.message.conversation,this.text=e.message.text,this.payload=e.message.payload,this.sender=e.initiator,this.timestamp=e.timestamp?e.timestamp:0,this.seq=e.message.seq}async edit(e,s){const n=await j(t.editMessage,{uuid:this.uuid,conversation:this.conversation,text:e,payload:s});return this._update(n),Promise.resolve(this)}async remove(){return await j(t.removeMessage,{uuid:this.uuid,conversation:this.conversation}),Promise.resolve()}_update(e){this.uuid=e.message.uuid,this.text=e.message.text,this.payload=e.message.payload,this.timestamp=e.timestamp?e.timestamp:0,this.seq=e.message.seq}}const R=function(e){const t={},s=function(t){return!e||Object.values(e).some((e=>e===t))},n=function(e,n){s(e)&&t[e.name]&&(t[e.name]=t[e.name].filter((e=>e.listener!==n)))};return{addEventListener:function(e,r,o){var i;s(e)&&(i=e.name,t[i]||(t[i]=[]),o&&o.signal&&(o.signal.onabort=function(){n(e,r)}),t[e.name].push({once:o&&o.once||!1,fulfilled:!1,listener:r}))},removeEventListener:n,dispatchEvent:function(e){const s=e.type.name;t[s]&&t[s].forEach((t=>{t.once&&t.fulfilled||t.listener(e),t.fulfilled=!0}))}}};class N extends class{constructor(){const e=R();this.addEventListener=e.addEventListener,this.removeEventListener=e.removeEventListener,this.dispatchEvent=e.dispatchEvent}}{constructor(e){super(),this.customData={},this.direct=!1,this.participants=[],this.enablePublicJoin=!1,this.title="",this.uberConversation=!1,this.uuid="",this.createdAt=0,this.lastSeq=0,this.lastUpdate=0,this._update(e)}_update(e){this.customData=e.customData,this.direct=e.direct,this.participants=e.participants,this.enablePublicJoin=e.enablePublicJoin,this.title=e.title,this.uberConversation=e.uberConversation,this.uuid=e.uuid,this.createdAt=e.createdAt,this.lastSeq=e.lastSeq,this.lastUpdate=e.lastUpdate}_serializeToPayload(){return{participants:this._serializeParticipants(this.participants).map((e=>Object.assign(e,{flags:e.flags?e.flags:7}))),title:this.title,direct:this.direct,enable_public_join:this.enablePublicJoin,uber_conversation:this.uberConversation,custom_data:this.customData}}_onSendMessage(e){this.dispatchEvent({type:d,target:this,timeStamp:Date.now(),message:new q(e)})}_onEditConversation(e){if("joinConversation"===e.messengerAction){const t=this.participants.map((e=>e.user_id)),s=e.conversation.participants.filter((e=>!t.includes(e.user_id)));this.participants=[...this.participants,...s],this.dispatchEvent({type:l,target:this,timeStamp:Date.now(),usersId:s.map((e=>e.user_id))})}else this.dispatchEvent({type:u,target:this,timeStamp:Date.now()})}_serializeParticipants(e){return e.map((e=>({user_id:e.userId,flags:this._getUserPermissions(e),last_read:e.lastRead})))}_getUserPermissions(e){const t=(e.isOwner?"1000000000":"")+[e.canRemoveAll,e.canEditAll,e.canManageParticipants,e.canRemove,e.canEdit,e.canWrite].map((e=>e?1:0)).join("");return parseInt(t,2)}retransmitEvents(e,n){return"number"!=typeof e||"number"!=typeof n?Promise.reject(new r(s.error_0.description,s.error_0.code)):j(t.retransmitEvents,{conversation:this.uuid,events_to:e,count:n})}async sendMessage(e,n){if("string"!=typeof e&&!(void 0!==n||Array.isArray(n)&&n.every((e=>e&&"object"==typeof e))))return Promise.reject(new r(s.error_0.description,s.error_0.code));const o=await j(t.sendMessage,{text:e,conversation:this.uuid,payload:n});return new q(o)}}function A(){return(e=>{if(-1===e.indexOf("@"))return e;{const t=e.split("@");return t[1]=t[1].split(".").splice(0,2).join("."),t.join("@")}})(f().username())}function G(e){return j(t.getUser,{user_name:e})}function D(e){let t=y(e.conversation.uuid);return t?t._update(e.conversation):(t=new N(e.conversation),_(e.conversation.uuid,t)),t}const T={getMe:A,getMyId:function(){return G(A()).then((e=>e.user.userId))},getUserById:function(e){return j(t.getUser,{user_id:e})},getUsersById:function(e){if(!Array.isArray(e))return Promise.reject(new r(s.error_0.description,s.error_0.code));const n=e.map((e=>({user_id:e})));return j(t.getUsers,{users:n})},getUser:G,getUsers:function(e){if(!Array.isArray(e))return Promise.reject(new r(s.error_0.description,s.error_0.code));const n=e.map((e=>({user_name:e})));return j(t.getUsers,{users:n})},editUser:function(e,s){const n={};return e&&(n.custom_data=e),s&&(n.private_custom_data=s),j(t.editUser,n)},setStatus:function(e){return j(t.setStatus,{online:e})},createConversation:async function(e){const s=new N(e),n=await j(t.createConversation,s._serializeToPayload());return _(n.conversation.uuid,s),s._update(n.conversation),Promise.resolve(s)},getConversation:async function(e){const s=await j(t.getConversation,{uuid:e});return Promise.resolve(D(s))},joinConversation:async function(e){const s=await j(t.joinConversation,{uuid:e});return Promise.resolve(D(s))},getConversations:async function(e){if(Array.isArray(e)&&e.length>30)return Promise.reject(new r(s.error_201.description,s.error_201.code));const n=(await j(t.getConversations,{uuid:e})).map((e=>D(e)));return Promise.resolve(n)},getPublicConversations:async function(){const e=(await j(t.getPublicConversations,{})).map((e=>D(e)));return Promise.resolve(e)}},I={major:5,minor:0,rev:0};let L;const O=function(e){L=e,(e=>{b=e})(e),L.registerModule(C)};return e.Events=v,e.Messaging=T,e.MessagingLoader=function(){return{dependencies:{},name:"messaging",setup:O,version:I}},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
//# sourceMappingURL=messaging.min.js.map
