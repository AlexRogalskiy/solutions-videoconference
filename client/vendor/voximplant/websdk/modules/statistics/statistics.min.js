this.Voximplant=this.Voximplant||{},this.Voximplant.statistics=function(e,t){"use strict";const o={major:5,minor:0,rev:0},a=function(e){};const i={process:function(e){return{connection:{timestamp:0,availableOutgoingBitrate:0,bytesReceived:0,bytesSent:0,rtt:0,localPort:0,localProtocol:"udp",localType:"relay",remotePort:0,remoteProtocol:"tcp",remoteType:"relay"},inbound:{},outbound:{}}},name:"rfc"};const s={calculateBitrate:function(e,t,o,a){return(e-t)/(o-a)*8e3},formatStats:function(e){const t=e,o=new Map;return t.forEach((e=>o.set(e.id,e))),[t,o]}};const r={process:function(e,t){const[o,a]=s.formatStats(e),i={},r={};let n={};return o.forEach((e=>{switch(e.type){case"outbound-rtp":{const t=a.get(e.remoteId),o=e.ssrc,i=t.packetsLost/(t.packetsLost+t.packetsReceived),s={kind:e.kind,bytesSent:e.bytesSent,packetsSent:e.packetsSent,jitter:0,rtt:t.roundTripTime||0,packetsLost:t.packetsLost,loss:i,timestamp:e.timestamp,bitrate:0};"video"===e.kind&&(s.framesPerSecond=e.framerateMean,s.bitrate=e.bitrateMean,s.firCount=e.firCount,s.pliCount=e.pliCount,s.nackCount=e.nackCount),r[o]=[s];break}case"inbound-rtp":{const o=e.ssrc,a=null==t?void 0:t.inbound[o];let r=0;switch(a&&(r=s.calculateBitrate(e.bytesReceived,a.bytesReceived,e.timestamp,a.timestamp)),i[o]={timestamp:e.timestamp,kind:e.kind,bytesReceived:e.bytesReceived||0,packetsReceived:e.packetsReceived||0,packetsLost:e.packetsLost||0,loss:e.packetsLost/(e.packetsReceived+e.packetsLost),jitter:e.jitter||0,bitrate:r},e.kind){case"video":i[o]=Object.assign(Object.assign({},i[o]),{framesDecoded:e.framesDecoded||0,framesPerSecond:e.framerateMean,bitrate:e.bitrateMean})}break}case"candidate-pair":{if("succeeded"!==e.state||!e.nominated)return;const t=a.get(e.remoteCandidateId),o=a.get(e.localCandidateId);if(!t||!o)return;const i=t.candidateType,s=t.ip||t.address,r=t.protocol,c=t.port,d=o.candidateType,l=o.ip||o.address,m=o.protocol,u=o.port,{bytesSent:p,bytesReceived:v,timestamp:f}=e;n={timestamp:f,remoteType:i,remoteIp:s,remoteProtocol:r,remotePort:c,localType:d,localIp:l,localProtocol:m,localPort:u,bytesSent:p,bytesReceived:v};break}}})),{connection:n,outbound:r,inbound:i}},name:"gecko"};const n={process:function(e,t){const[o,a]=s.formatStats(e),i={},r={};let n={};return o.forEach((e=>{switch(e.type){case"outbound-rtp":{const o=a.get(e.remoteId),i=a.get(e.codecId),n=a.get(e.trackId),c=a.get(e.mediaSourceId);console.error(n,e,e.mediaSourceId,c);const d=n.trackIdentifier,l=e.rid?null==t?void 0:t.outbound[d].find((t=>t.rid===e.rid)):null==t?void 0:t.outbound[d][0];let m=0;l&&(m=s.calculateBitrate(e.bytesSent,l.bytesSent,e.timestamp,l.timestamp));const u={bytesSent:e.bytesSent,packetsSent:e.packetsSent,rid:e.rid,jitter:0,rtt:0,totalRtt:0,packetsLost:0,loss:0,codec:i.mimeType,pt:i.payloadType,timestamp:e.timestamp,bitrate:m};if(o){u.jitter=o.jitter,u.rtt=o.roundTripTime,u.packetsLost=o.packetsLost;const t=o.packetsLost||0;u.loss=t/(e.packetsSent+t)}switch(e.kind){case"audio":u.kind="audio";break;case"video":{const{frameWidth:t,frameHeight:o}=n;u.kind="video",u.baseWidth=t,u.baseHeight=o,u.width=e.frameWidth||0,u.height=e.frameHeight||0,u.framesPerSecond=e.framesPerSecond||0,u.qualityLimitationReason=e.qualityLimitationReason,u.qualityLimitationResolutionChanges=e.qualityLimitationResolutionChanges,u.firCount=e.firCount,u.pliCount=e.pliCount,u.nackCount=e.nackCount,u.qpSum=e.qpSum,u.framesEncoded=e.framesEncoded,u.keyFramesEncoded=e.keyFramesEncoded;break}}r[d]||(r[d]=[]),r[d].push(u);break}case"inbound-rtp":{const o=a.get(e.trackId);if(!o)return;const r=o.trackIdentifier,n=null==t?void 0:t.inbound[r];let c=0;switch(n&&(c=s.calculateBitrate(e.bytesReceived,n.bytesReceived,e.timestamp,n.timestamp)),i[r]={timestamp:e.timestamp,kind:e.kind,bytesReceived:e.bytesReceived||0,packetsReceived:e.packetsReceived||0,packetsLost:e.packetsLost||0,loss:e.packetsLost/(e.packetsReceived+e.packetsLost),jitter:0,bitrate:c},e.kind){case"audio":{const{audioLevel:t}=o;i[r]=Object.assign(Object.assign({},i[r]),{jitter:e.jitter,audioLevel:t,totalAudioEnergy:e.totalAudioEnergy||0,totalSamplesReceived:e.totalSamplesReceived||0,totalSamplesDuration:e.totalSamplesDuration||0,insertedSamplesForDeceleration:e.insertedSamplesForDeceleration||0,silentConcealedSamples:e.silentConcealedSamples||0});break}case"video":{let t=0;if(n&&n.framesReceived){const o=n.framesReceived||e.framesReceived;t=(e.framesReceived-o)/(e.timestamp-n.timestamp)*1e3|0}const{freezeCount:a,pauseCount:s,totalFramesDuration:c,totalFreezesDuration:d,totalPausesDuration:l}=o;i[r]=Object.assign(Object.assign({},i[r]),{height:e.frameHeight||0,width:e.frameWidth||0,framesReceived:e.framesReceived||0,framesDecoded:e.framesDecoded||0,freezeCount:a,pauseCount:s,totalFramesDuration:c,totalFreezesDuration:d,totalPausesDuration:l,framesPerSecond:t});break}}break}case"candidate-pair":{if("succeeded"!==e.state||!e.nominated)return;const t=a.get(e.remoteCandidateId),o=a.get(e.localCandidateId);if(!t||!o)return;const i=t.candidateType,s=t.protocol,r=t.port,c=o.candidateType,d=o.protocol,l=o.port,m=e.totalRoundTripTime,u=e.currentRoundTripTime,{bytesSent:p,bytesReceived:v,availableOutgoingBitrate:f,timestamp:b}=e;n={timestamp:b,remoteType:i,remoteProtocol:s,remotePort:r,localType:c,localProtocol:d,localPort:l,bytesSent:p,bytesReceived:v,availableOutgoingBitrate:f,rtt:m,currentRtt:u};break}}})),{connection:n,outbound:r,inbound:i}},name:"webkit"};const c={process:function(e,t){const[o,a]=s.formatStats(e),i={},r={};let n={};return o.forEach((e=>{switch(e.type){case"outbound-rtp":{const o=a.get(e.remoteId),i=a.get(e.codecId),n=a.get(e.trackId),c=a.get(n.mediaSourceId),d=c.trackIdentifier,l=e.rid?null==t?void 0:t.outbound[d].find((t=>t.rid===e.rid)):null==t?void 0:t.outbound[d][0];let m=0;l&&(m=s.calculateBitrate(e.bytesSent,l.bytesSent,e.timestamp,l.timestamp));const u={bytesSent:e.bytesSent,packetsSent:e.packetsSent,rid:e.rid,jitter:0,rtt:0,totalRtt:0,packetsLost:0,loss:0,codec:i.mimeType,pt:i.payloadType,timestamp:e.timestamp,bitrate:m};switch(o&&(u.jitter=o.jitter,u.rtt=o.roundTripTime,u.totalRtt=o.totalRoundTripTime||o.roundTripTime,u.packetsLost=o.packetsLost,u.loss=o.packetsLost/(e.packetsSent+o.packetsLost)),e.kind){case"audio":{const e=c;u.kind="audio",u.audioLevel=e.audioLevel||0,u.totalAudioEnergy=e.totalAudioEnergy||0;break}case"video":{const t=c;u.kind="video",u.baseWidth=t.width,u.baseHeight=t.height,u.width=e.frameWidth||0,u.height=e.frameHeight||0,u.framesPerSecond=e.framesPerSecond||0,u.baseFramesPerSecond=t.framesPerSecond,u.qualityLimitationReason=e.qualityLimitationReason,u.qualityLimitationResolutionChanges=e.qualityLimitationResolutionChanges,u.firCount=e.firCount,u.pliCount=e.pliCount,u.nackCount=e.nackCount,u.qpSum=e.qpSum,u.framesEncoded=e.framesEncoded,u.keyFramesEncoded=e.keyFramesEncoded;break}}r[d]||(r[d]=[]),r[d].push(u);break}case"inbound-rtp":{const o=a.get(e.trackId);if(!o)return;const r=o.trackIdentifier,n=null==t?void 0:t.inbound[r];let c=0;switch(n&&(c=s.calculateBitrate(e.bytesReceived,n.bytesReceived,e.timestamp,n.timestamp)),i[r]={timestamp:e.timestamp,kind:o.kind,bytesReceived:e.bytesReceived||0,packetsReceived:e.packetsReceived||0,packetsLost:e.packetsLost||0,loss:e.packetsLost/(e.packetsReceived+e.packetsLost),jitter:e.jitter||0,bitrate:c},o.kind){case"audio":i[r]=Object.assign(Object.assign({},i[r]),{audioLevel:o.audioLevel||0,totalAudioEnergy:o.totalAudioEnergy||0,totalSamplesReceived:o.totalSamplesReceived||0,totalSamplesDuration:o.totalSamplesDuration||0,insertedSamplesForDeceleration:o.insertedSamplesForDeceleration||0,silentConcealedSamples:o.silentConcealedSamples||0});break;case"video":{let t=0;if(n&&n.framesReceived){const a=n.framesReceived||o.framesReceived;t=(o.framesReceived-a)/(e.timestamp-n.timestamp)*1e3|0}i[r]=Object.assign(Object.assign({},i[r]),{height:o.frameHeight||0,width:o.frameWidth||0,framesReceived:o.framesReceived||0,framesDecoded:o.framesDecoded||0,framesDropped:o.framesDropped||0,framesPerSecond:t});break}}break}case"candidate-pair":{if("succeeded"!==e.state||!e.nominated)return;const t=a.get(e.remoteCandidateId),o=a.get(e.localCandidateId);if(!t||!o)return;const i=t.candidateType,s=t.ip||t.address,r=t.protocol,c=t.port,d=o.candidateType,l=o.ip||o.address,m=o.protocol,u=o.port,p=e.totalRoundTripTime,v=e.currentRoundTripTime,{bytesSent:f,bytesReceived:b,availableOutgoingBitrate:k,timestamp:y}=e;n={timestamp:y,remoteType:i,remoteIp:s,remoteProtocol:r,remotePort:c,localType:d,localIp:l,localProtocol:m,localPort:u,bytesSent:f,bytesReceived:b,availableOutgoingBitrate:k,rtt:p,currentRtt:v};break}}})),{connection:n,outbound:r,inbound:i}},name:"blink"};function d(e){return void 0!==e.address&&void 0!==e.isRemote||void 0!==e.ip&&void 0!==e.isRemote}function l(e,t=!1){let o=!0;return e.forEach((e=>{if(o){switch(e.type){case"candidate-pair":o=void 0!==(a=e).lastPacketReceivedTimestamp&&void 0!==a.lastPacketSentTimestamp;break;case"inbound-rtp":o=function(e){return console.error(e),"video"!==e.kind||void 0!==e.discardedPackets&&void 0!==e.bitrateMean&&void 0!==e.bitrateStdDev&&void 0!==e.framerateMean&&void 0!==e.framerateStdDev&&void 0!==e.framesDecoded}(e)}t&&console.error("After "+e.type,o)}var a})),t&&console.error("Gecko detection result is:",o),o}function m(e){return void 0!==e.deleted}const u="voximplant_statistics_collectStats",p="voximplant_statistics_collectStats_measure";let v=!1;const f=new Set,b=new Map;let k=!1,y=1e3;function S(e){return function(e,t=!1){let o=!0,a=!1;return e.forEach((e=>{if(o){switch(e.type){case"peer-connection":a=!0;break;case"media-source":o="audio"===(i=e).kind?void 0!==i.audioLevel&&void 0!==i.totalAudioEnergy&&void 0!==i.totalSamplesDuration:"video"===i.kind&&void 0!==i.width&&void 0!==i.height&&void 0!==i.framesPerSecond;break;case"local-candidate":case"remote-candidate":o=d(e);break;case"transport":o=function(e){return void 0!==e.packetsSent&&void 0!==e.packetsReceived}(e);break;case"inbound-rtp":o=function(e){return"audio"===e.kind||"video"===e.kind&&void 0!==e.decoderImplementation}(e);break;case"outbound-rtp":o=function(e){return"audio"===e.kind||"video"===e.kind&&void 0!==e.qualityLimitationReason&&void 0!==e.encoderImplementation}(e);break;case"track":o=function(e){return void 0!==e.kind}(e)}t&&console.error("After "+e.type,o)}var i})),a||(o=!1),t&&console.error("Blink detection result is:",o),o}(e,v)?c:function(e,t=!1){let o=!0,a=!1;return e.forEach((e=>{if(o){switch(e.type){case"peer-connection":a=!0;break;case"local-candidate":case"remote-candidate":o=m(e);break;case"track":o=function(e){if(e.framesReceived){const t=e;return void 0!==t.freezeCount&&void 0!==t.pauseCount&&void 0!==t.sumOfSquaredFramesDuration&&void 0!==t.totalFramesDuration&&void 0!==t.totalFreezesDuration&&void 0!==t.totalPausesDuration}return!0}(e)}t&&console.error("After "+e.type,o)}})),a||(o=!1),t&&console.error("Webkit detection result is:",o),o}(e,v)?n:l(e,v)?r:i}let g=i;async function R(){performance.mark(u),async function(){const e=navigator.getBattery;if(e){const t=await e();if(!t.charging)return t.level&&t.level<=.3?1e4:3e3}return 1e3}().then((e=>{y=e}));let e=0;for(const o of f.values())if("connected"===o.connectionState){e++;const a=await o.getStats(),i=S(a);i.name!==g.name&&(t.SDK.log(`Stats strategy changed from ${g.name} to ${i.name}`,{logLevel:"verbose"}),g=i);const s=g.process(a,b.get(o));b.set(o,JSON.parse(JSON.stringify(s)))}performance.measure(p,u);const o=performance.getEntriesByName(p);t.SDK.log(`Collected stats for ${e} of ${f.size}. Time: ${o[0].duration}`,{logLevel:"verbose"}),performance.clearMarks(u),performance.clearMeasures(p)}return e.StatisticsLoader=function(e){return{dependencies:{},name:"statistics",setup:a,version:o}},e.registerSource=function(e,o){t.SDK.log("Add a new statistic source",{logLevel:"verbose"}),o.addEventListener("abort",(function(){t.SDK.log("Abort statistic source",{logLevel:"verbose"}),function(e){f.delete(e),t.SDK.log("Statics source was removed ",{logLevel:"verbose"}),0===f.size&&(t.SDK.log("Statics interval was stopped",{logLevel:"verbose"}),k=!1)}(e)})),function(e){f.add(e),t.SDK.log("Statics source was added ",{logLevel:"verbose"}),k||setTimeout(R,y)}(e)},Object.defineProperty(e,"__esModule",{value:!0}),e}({},Voximplant);
//# sourceMappingURL=statistics.min.js.map
